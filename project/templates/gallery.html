{% extends 'base.html' %}
{% block main %}
<!-- display all images -->

<div class="container">
    <h1 class="text-center">Gallery</h1>
    <div class="dropdown mb-4 text-end">
        <button class="btn btn-secondary dropdown-toggle px-4 py-2" type="button" id="categoryDropdown"
            data-bs-toggle="dropdown" aria-expanded="false">
            Category
        </button>

        <ul class="dropdown-menu shadow" aria-labelledby="categoryDropdown">
            <li>
                <a class="dropdown-item {% if selected_category == 'all' %}active{% endif %}"
                    href="{{ url_for('main.gallery', category='all') }}">
                    All Categories
                </a>
            </li>

            {% for cat in categories %}
            <li>
                <a class="dropdown-item {% if selected_category == cat[0] %}active{% endif %}"
                    href="{{ url_for('main.gallery', category=cat[0]) }}">
                    {{ cat[1] }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="row gx-4 gy-4 mt-4">
        {% for img in images %}
        <div class="col-md-3">
            <div class="card h-100">
                <a href="{{url_for('main.item_detail', imageID=img.imageID) }}">
                    <img src="{{ url_for('static', filename='img/' + img.imageID + img.extension) }}"
                        alt="{{ img.title }}" class="card-img-top"
                        style="max-height: 200px; height:200px; object-fit: cover;">
                </a>

                <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                        <a class="text-decoration-none text-reset"
                            href=" {{url_for('main.item_detail', imageID=img.imageID) }}">
                            <h5 class="card-title">{{ img.title }}</h5>
                        </a>
                        <p class="card-text">
                            <i class="bi bi-tag-fill"></i>
                            <strong>Price:</strong> {{ img.currency }} ${{ img.price }}
                        </p>
                    </div>

                    <div class="mt-3">
                        {% if img.imageID in boughtIDImages or img.userID == userID %}
                        <button class="btn btn-secondary w-100" title="You have already bought this image">
                            Download
                        </button>
                        {% else %}
                        <button class="btn btn-dark w-100" onclick="addCart('{{ img.imageID }}')">
                            Add to cart
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if images|length == 0 %}
    <div class="alert alert-info text-center mt-4">No images found in this category</div>
    {% else %}
    <nav aria-label="Page navigation" class="d-flex justify-content-center mt-4">
        <ul class="pagination">
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link text-reset text-decoration-none"
                    href="{{ url_for('main.gallery', page=page-1) if page > 1 else '#' }}">
                    Previous
                </a>
            </li>

            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active bg-dark border-dark text-white{% endif %}">
                <a class="page-link text-reset text-decoration-none {% if p == page %}bg-dark border-dark text-white{% endif %}"
                    href="{{ url_for('main.gallery', page=p) }}">{{ p
                    }}</a>
            </li>
            {% endfor %}

            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                <a class="page-link text-reset text-decoration-none"
                    href="{{ url_for('main.gallery', page=page+1) if page < total_pages else '#' }}">
                    Next
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}

</div>
{% endblock %}
{% block scripts %}
<script>
    async function addCart(imageID) {
        confirm('Do you want to add this item to your cart?');
        const response = await fetch(`/cart/${imageID}`, { method: "POST" });
        if (response.status === 401) {
            const data = await response.json();
            window.location.href = data.redirect;  // chuyển trang tại client
            return;
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}